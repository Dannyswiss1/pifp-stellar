name: Deploy to Futurenet

on:
  push:
    branches: [ "main" ]

env:
  # Targeting the specific contract directory mentioned in the docs
  MANIFEST_PATH: contracts/pifp_protocol/Cargo.toml

jobs:
  deploy:
    name: Build and Deploy Contract
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # Modern, actively maintained Rust toolchain
      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Add wasm32v1-none target
        run: rustup target add wasm32v1-none

      # Cache to optimize build times per requirements
      - name: Cache Cargo Registry & Build Artifacts
        uses: Swatinem/rust-cache@v2

      - name: Install Stellar CLI
        # Downloading the pre-compiled binary saves ~5 minutes compared to 'cargo install'
        run: |
          wget https://github.com/stellar/stellar-cli/releases/download/v25.1.0/stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          sudo mv stellar /usr/local/bin/

      - name: Build Smart Contract
        # Compiles the contract to the wasm32 target
        run: stellar contract build --manifest-path ${{ env.MANIFEST_PATH }}

      - name: Deploy to Futurenet
        # Securely maps the GitHub Secret to an environment variable for this specific step
        env:
          SOROBAN_SECRET_KEY: ${{ secrets.SOROBAN_SECRET_KEY }}
        run: |
          # 0. Configure network

          # 0. Configure network
          stellar network add --rpc-url https://rpc-futurenet.stellar.org:443 --network-passphrase "Test SDF Future Network ; October 2022" futurenet

          # 0b. Configure identity
          echo "$SOROBAN_SECRET_KEY" | stellar keys add deployer --force

          # 1. Deploy the contract and capture the output ID
          CONTRACT_ID=$(stellar contract deploy \
            --wasm target/wasm32v1-none/release/pifp_protocol.wasm \
            --source deployer \
            --network futurenet)
          
          echo "Successfully deployed to Futurenet! Contract ID: $CONTRACT_ID"
          
          # 2. Write the ID to deployments.json
          echo "{\"contract_id\": \"$CONTRACT_ID\", \"network\": \"futurenet\", \"timestamp\": \"$(date -u +'%Y-%m-%dT%H:%M:%SZ')\"}" > deployments.json

      - name: Upload Deployment Artifact
        # Safely exposes the deployments.json file for frontend devs to download
        # without polluting the Git commit history and causing an infinite CI loop.
        uses: actions/upload-artifact@v4
        with:
          name: deployments-json
          path: deployments.json

  publish-sdk:
    name: Generate and Publish SDK
    needs: deploy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Download Deployment Artifact
        uses: actions/download-artifact@v4
        with:
          name: deployments-json

      - name: Install Stellar CLI
        # Downloading the pre-compiled binary saves ~5 minutes compared to 'cargo install'
        run: |
          wget https://github.com/stellar/stellar-cli/releases/download/v25.1.0/stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          tar -xzf stellar-cli-25.1.0-x86_64-unknown-linux-gnu.tar.gz
          sudo mv stellar /usr/local/bin/

      - name: Install Rust Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown
      - name: Add wasm32v1-none target
        run: rustup target add wasm32v1-none

      - name: Build Smart Contract
        run: stellar contract build --manifest-path ${{ env.MANIFEST_PATH }}

      - name: Generate TypeScript Bindings
        run: |
          # 0. Configure network
          stellar network add --rpc-url https://rpc-futurenet.stellar.org:443 --network-passphrase "Test SDF Future Network ; October 2022" futurenet

          CONTRACT_ID=$(jq -r '.contract_id' deployments.json)
          stellar contract bindings typescript \
            --wasm target/wasm32v1-none/release/pifp_protocol.wasm \
            --id "$CONTRACT_ID" \
            --network futurenet \
            --output-dir ./sdk

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@sorolabs'

      - name: Configure and Version SDK
        run: |
          VERSION_BASE=$(cat sdk_version.txt)
          FULL_VERSION="${VERSION_BASE}.${{ github.run_number }}"
          cd sdk
          
          # Update package.json with name and version
          jq --arg name "@sorolabs/pifp-sdk" --arg version "$FULL_VERSION" \
            '.name = $name | .version = $version' \
            package.json > package.json.tmp && mv package.json.tmp package.json
          
          echo "Generated SDK version: $FULL_VERSION"

      - name: Publish to GitHub Packages
        run: |
          cd sdk
          npm publish
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}